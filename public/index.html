<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>搶答系統</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      text-align: center;
    }

    h1 {
      color: #333;
      margin-bottom: 30px;
      font-size: 28px;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    input[type="text"] {
      width: 100%;
      padding: 15px 20px;
      font-size: 18px;
      border: 2px solid #ddd;
      border-radius: 10px;
      margin-bottom: 20px;
      outline: none;
      transition: border-color 0.3s;
    }

    input[type="text"]:focus {
      border-color: #667eea;
    }

    .btn {
      width: 100%;
      padding: 15px 30px;
      font-size: 20px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      font-weight: bold;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    }

    .btn-buzz {
      background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
      color: white;
      width: 250px;
      height: 250px;
      border-radius: 50%;
      font-size: 48px;
      margin: 30px auto;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 10px 40px rgba(245, 87, 108, 0.4);
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
    }

    .btn-buzz:hover {
      transform: scale(1.05);
      box-shadow: 0 15px 50px rgba(245, 87, 108, 0.5);
    }

    .btn-buzz:active {
      transform: scale(0.95);
    }

    .btn-buzz.buzzed {
      background: linear-gradient(135deg, #a8e063 0%, #56ab2f 100%);
      box-shadow: 0 10px 40px rgba(86, 171, 47, 0.4);
    }

    .btn-buzz.disabled {
      background: linear-gradient(135deg, #999 0%, #777 100%);
      box-shadow: 0 10px 40px rgba(100, 100, 100, 0.3);
      cursor: not-allowed;
    }

    .btn-buzz.disabled:hover {
      transform: none;
    }

    .btn-buzz.disabled:active {
      transform: none;
    }

    .welcome {
      color: #666;
      font-size: 18px;
      margin-bottom: 20px;
    }

    .guest-name {
      color: #667eea;
      font-weight: bold;
    }

    .position {
      font-size: 24px;
      color: #56ab2f;
      margin-top: 20px;
      font-weight: bold;
    }

    .waiting {
      color: #999;
      font-size: 16px;
      margin-top: 20px;
    }

    .error {
      color: #f5576c;
      font-size: 14px;
      margin-top: 10px;
    }

    .connection-status {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      padding: 10px;
      text-align: center;
      font-size: 14px;
      font-weight: bold;
      z-index: 1000;
      transition: transform 0.3s ease;
    }

    .connection-status.connected {
      background: #56ab2f;
      color: white;
      transform: translateY(-100%);
    }

    .connection-status.disconnected {
      background: #f5576c;
      color: white;
      transform: translateY(0);
    }

    .connection-status.reconnecting {
      background: #f5a623;
      color: white;
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div id="connectionStatus" class="connection-status connected">已連線</div>
  <div class="container">
    <!-- Registration Page -->
    <div id="registerPage" class="page active">
      <h1>歡迎加入</h1>
      <input type="text" id="nameInput" placeholder="請輸入你的名字" maxlength="20">
      <button class="btn btn-primary" id="registerBtn">確認</button>
      <p class="error" id="errorMsg"></p>
    </div>

    <!-- Buzz Page -->
    <div id="buzzPage" class="page">
      <p class="welcome">歡迎, <span class="guest-name" id="displayName"></span>!</p>
      <button class="btn btn-buzz" id="buzzBtn">搶答</button>
      <p class="position" id="positionMsg"></p>
      <p class="waiting" id="waitingMsg">等待下一題...</p>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    const registerPage = document.getElementById('registerPage');
    const buzzPage = document.getElementById('buzzPage');
    const nameInput = document.getElementById('nameInput');
    const registerBtn = document.getElementById('registerBtn');
    const errorMsg = document.getElementById('errorMsg');
    const displayName = document.getElementById('displayName');
    const buzzBtn = document.getElementById('buzzBtn');
    const positionMsg = document.getElementById('positionMsg');
    const waitingMsg = document.getElementById('waitingMsg');
    const connectionStatus = document.getElementById('connectionStatus');

    let hasBuzzed = false;
    let isRoundActive = false;
    let isConnected = false;
    let myName = null;

    // Connection status handlers
    socket.on('connect', () => {
      isConnected = true;
      updateConnectionStatus('connected');
      // Re-register if we have a saved name (reconnection scenario)
      const savedName = localStorage.getItem('guestName');
      if (savedName) {
        socket.emit('register', savedName);
      }
    });

    socket.on('disconnect', () => {
      isConnected = false;
      updateConnectionStatus('disconnected');
    });

    socket.io.on('reconnect_attempt', () => {
      updateConnectionStatus('reconnecting');
    });

    function updateConnectionStatus(status) {
      connectionStatus.className = 'connection-status ' + status;
      if (status === 'connected') {
        connectionStatus.textContent = '已連線';
      } else if (status === 'disconnected') {
        connectionStatus.textContent = '連線已斷開，正在重新連線...';
      } else if (status === 'reconnecting') {
        connectionStatus.textContent = '正在重新連線...';
      }
      // Update buzz button state based on connection
      if (buzzPage.classList.contains('active')) {
        updateBuzzButton();
      }
    }

    // Check for saved name on initial load
    const savedName = localStorage.getItem('guestName');
    if (savedName && socket.connected) {
      socket.emit('register', savedName);
    }

    registerBtn.addEventListener('click', register);
    nameInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') register();
    });

    function register() {
      const name = nameInput.value.trim();
      if (!name) {
        errorMsg.textContent = '請輸入名字';
        return;
      }
      socket.emit('register', name);
    }

    socket.on('registered', (data) => {
      if (data.success) {
        localStorage.setItem('guestName', data.name);
        displayName.textContent = data.name;
        registerPage.classList.remove('active');
        buzzPage.classList.add('active');
        resetBuzzState();
        socket.emit('getState');
      }
    });

    function handleBuzz(e) {
      e.preventDefault();
      if (!hasBuzzed && isRoundActive && isConnected) {
        socket.emit('buzz');
      }
    }

    buzzBtn.addEventListener('click', handleBuzz);
    buzzBtn.addEventListener('touchend', handleBuzz);

    socket.on('buzzResult', (data) => {
      if (data.success) {
        hasBuzzed = true;
        buzzBtn.classList.add('buzzed');
        buzzBtn.textContent = '已搶答';
        positionMsg.textContent = `你是第 ${data.position} 位!`;
        waitingMsg.style.display = 'none';
      } else {
        positionMsg.textContent = data.message;
      }
    });

    socket.on('recordsCleared', () => {
      resetBuzzState();
      setRoundActive(false);
    });

    socket.on('roundStarted', () => {
      setRoundActive(true);
    });

    socket.on('roundState', (active) => {
      setRoundActive(active);
    });

    function setRoundActive(active) {
      isRoundActive = active;
      updateBuzzButton();
    }

    function updateBuzzButton() {
      if (!isConnected) {
        buzzBtn.classList.add('disabled');
        buzzBtn.textContent = '斷線中';
        waitingMsg.textContent = '連線已斷開...';
      } else if (isRoundActive && !hasBuzzed) {
        buzzBtn.classList.remove('disabled');
        buzzBtn.textContent = '搶答';
        waitingMsg.textContent = '快按搶答!';
      } else if (!isRoundActive && !hasBuzzed) {
        buzzBtn.classList.add('disabled');
        buzzBtn.textContent = '等待';
        waitingMsg.textContent = '等待主持人開始...';
      }
    }

    function resetBuzzState() {
      hasBuzzed = false;
      buzzBtn.classList.remove('buzzed');
      positionMsg.textContent = '';
      waitingMsg.style.display = 'block';
      updateBuzzButton();
    }
  </script>
</body>
</html>
